<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR Scan to Info</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="w-full max-w-md p-4 bg-white rounded-xl shadow-xl text-center">
    <h2 class="text-xl font-semibold mb-4">Scan QR with Camera</h2>
    <div id="reader" class="w-full mx-auto"></div>
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50">
      <div class="text-white text-lg animate-pulse">កំពុងដំណើរការ...</div>
    </div>
    <div id="customer-info" class="mt-4 hidden">
      <h3 class="font-bold text-lg mb-2">🔍 លទ្ធផល:</h3>
      <div id="info-output" class="text-left text-sm"></div>
    </div>
  </div>

  <script>
    function extractIDfromURL(url) {
      const match = url.match(/\?id=([^&]+)/);
      return match ? match[1] : null;
    }

    function showLoading(show) {
      document.getElementById("loading-overlay").classList.toggle("hidden", !show);
    }

    function showCustomerInfo(data) {
      const output = document.getElementById("info-output");
      const container = document.getElementById("customer-info");
      output.innerHTML = `
        <div><strong>លេខកូដ:</strong> ${data.id}</div>
        <div><strong>ឈ្មោះ:</strong> ${data.name}</div>
        <div><strong>បន្ទប់:</strong> ${data.room}</div>
        <div><strong>ទូរស័ព្ទ:</strong> ${data.phone} ${data.phone2 ? ' / ' + data.phone2 : ''}</div>
      `;
      container.classList.remove("hidden");
    }

    async function fetchCustomerInfo(id) {
      try {
        showLoading(true);
        const doc = await firebase.firestore().collection("customers").doc(id).get();
        showLoading(false);
        if (doc.exists) {
          showCustomerInfo({ id, ...doc.data() });
        } else {
          alert("❌ មិនមានទិន្នន័យសម្រាប់ ID: " + id);
        }
      } catch (error) {
        showLoading(false);
        alert("មានបញ្ហា!" + error);
      }
    }

    // QR Scanner Init
    const html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: 250 };

    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        const cameraId = devices[0].id;
        html5QrCode.start(
          cameraId,
          config,
          (decodedText) => {
            html5QrCode.stop();
            const id = extractIDfromURL(decodedText);
            if (id) {
              fetchCustomerInfo(id);
            } else {
              alert("QR មិនត្រឹមត្រូវទេ!");
            }
          },
          error => {}
        );
      }
    }).catch(err => alert("មិនរកឃើញកាមេរា: " + err));
  </script>

  <!-- Firebase Init -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD61vUNw4gFmzR4zfS8s7FVIzsJe9nXQHQ",
  authDomain: "home-invoice-e1f43.firebaseapp.com",
  databaseURL: "https://home-invoice-e1f43-default-rtdb.firebaseio.com",
  projectId: "home-invoice-e1f43",
  storageBucket: "home-invoice-e1f43.appspot.com",  // <-- ចំណាំទីនេះ
  messagingSenderId: "243294137874",
  appId: "1:243294137874:web:8bdc0aab16ca58f4d932cb",
    };
    firebase.initializeApp(firebaseConfig);
  </script>
</body>
</html>
