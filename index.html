<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invoice Lookup by CustomerID + QR Scan + Chart</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
    font-family: 'Khmer OS', 'Khmer OS System', 'Khmer OS Content', Arial, sans-serif;
  }
    #qr-video {
      width: 100%;
      max-height: 280px;
      border-radius: 1rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      margin-top: 1rem;
      display: none;
      object-fit: cover;
    }
    #invoice-table tbody tr:hover {
      background-color: #bfdbfe;
      cursor: pointer;
    }

    /* Modal styles */
    #invoice-modal {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    #invoice-modal .modal-content {
      background: white;
      border-radius: 1rem;
      max-width: 600px;
      width: 90%;
      padding: 1.5rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      position: relative;
    }
    #invoice-modal .close-btn {
      position: absolute;
      top: 0.5rem;
      right: 1rem;
      font-size: 2rem;
      color: #555;
      cursor: pointer;
      font-weight: bold;
    }
    #invoice-modal .close-btn:hover {
      color: #111;
    }
  </style>
</head>
<body class="bg-blue-50 min-h-screen flex flex-col justify-center items-center p-4">

  <div class="bg-white rounded-3xl shadow-xl max-w-4xl w-full p-6 flex flex-col items-center">
    <h4 class="text-3xl font-extrabold text-blue-700 mb-6 text-center">Invoice áá¶á˜ CustomerID</h4>

   <input id="customer-id" type="text" placeholder=" Customer ID á¬ Scan QR" autocomplete="off" readonly
  class="rounded-xl border border-blue-500 bg-gray-100 text-gray-900 px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full max-w-md placeholder-gray-500" />



    <div class="flex gap-4 mt-4">
      <button id="btnSearch"
        >
      
      </button>
      <button id="btnScan"
        class="bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-8 rounded-xl font-semibold shadow-md transition">
        ğŸ“· Scan QR
      </button>


<!-- QR Upload Button -->
<input type="file" accept="image/*" id="uploadQRInput" style="display: none;">
<button onclick="document.getElementById('uploadQRInput').click()">ğŸ“· Upload QR</button>






      <button id="btnStopScan" class="bg-red-600 hover:bg-red-700 text-white py-3 px-8 rounded-xl font-semibold shadow-md transition hidden">
        âœ– á”á‰áŸ’áˆá”áŸ‹ Scan
      </button>
    </div>

    <div class="flex items-center gap-3 mt-6 max-w-md w-full">
      <label for="month-filter" class="font-semibold">á‡áŸ’ášá¾áŸášá¾áŸ ááŸ‚-á†áŸ’á“á¶áŸ†:</label>
      <select id="month-filter" class="border rounded px-3 py-2 w-full">
        <option value="">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
      </select>
    </div>

    <video id="qr-video" autoplay muted playsinline></video>

    <div id="results" class="w-full mt-8 text-gray-600 min-h-[160px] p-4 rounded-xl bg-indigo-50 shadow-inner overflow-auto max-h-96">
      <p class="text-center text-gray-400 italic">áŸá¼á˜á”á‰áŸ’á…á¼á› Customer ID á¬ Scan QR áŠá¾á˜áŸ’á”á¸á˜á¾á› Invoice</p>
    </div>

    <div id="cart-summary" class="mt-6 bg-white rounded-lg shadow p-4 w-full max-w-md text-gray-700 hidden">
      <div class="flex justify-end w-full mt-4">
        <button onclick="exportCSV()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded-xl font-semibold shadow-md">
          ğŸ“¤ á”á‰áŸ’á‡á¼á“á…áŸá‰ CSV
        </button>
      </div>

      <h3 class="text-lg font-bold mb-2">áŸá„áŸ’ááŸá” Invoice</h3>
      <p>á‘á¹á€á”áŸ’ášá¾áŸášá»á”áŸ– <span id="total-water-used">0</span> á›á¸ááŸ’áš</p>
      <p>áá˜áŸ’á›áŸƒá‘á¹á€áŸášá»á”áŸ– <span id="total-water-price">0</span> áŸ›</p>
      <p>áá˜áŸ’á›áŸƒá—áŸ’á›á¾á„áŸášá»á”áŸ– <span id="total-electric-price">0</span> áŸ›</p>
    </div>

    <div class="mt-8 w-full max-w-4xl">
      <canvas id="invoiceChart"></canvas>
    </div>



<!-- Chat Toggle Button (Floating Icon) -->
<button id="chat-toggle"
  class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg focus:outline-none transition-all duration-300 z-50 animate-bounce">
  <!-- Icon Chat Bubble (Heroicons) -->
  <svg id="chat-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transition-transform duration-300" fill="none"
    viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
      d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.77 9.77 0 01-4-.837l-4.2.837.838-4.2A8.963 8.963 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
  </svg>
</button>
<!-- Chat Box -->
<div id="chat-box"
  class="fixed bottom-20 right-4 w-[90vw] max-w-md bg-white border border-gray-300 rounded-xl shadow-lg hidden flex flex-col z-50 sm:w-80 transition-all duration-300 transform opacity-0 scale-95">
  <!-- Header -->
  <div class="bg-blue-600 text-white px-4 py-3 rounded-t-xl">
    <h3 class="text-lg font-semibold">Chat</h3>
  </div>

  <!-- Messages -->
  <div id="chat-messages" class="p-4 flex-1 overflow-y-auto space-y-2 text-sm max-h-60">
    <div class="bg-gray-100 p-2 rounded-md text-left">áŸá½áŸáŸ’áŠá¸! áá¾ááŸ’á‰á»áŸ†á¢á¶á…á‡á½á™á¢áŸ’áœá¸á”á¶á“ááŸ’á›áŸ‡?</div>
  </div>

  <!-- Input -->
  <div class="p-3 border-t border-gray-200 flex gap-2">
    <input id="chat-input" type="text" placeholder="áŸášáŸáŸášâ€‹áŸá¶áš..."
      class="flex-1 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
    <button id="send-button"
      class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm">Send</button>
  </div>
</div>








  </div>

  <!-- Modal for invoice detail -->
  <div id="invoice-modal">
    <div class="modal-content">
      <span id="modal-close-btn" class="close-btn">&times;</span>
      <h2 class="text-xl font-bold mb-4 text-center text-blue-700">á›á˜áŸ’á¢á·ááœá·á€áŸ’á€á™á”ááŸ’áš</h2>
      <div id="modal-content" class="text-gray-700"></div>
      <div class="flex justify-end mt-6 gap-3">
        <button id="modal-print-btn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-xl font-semibold shadow-md">
          ğŸ–¨ï¸ á”áŸ„áŸ‡á–á»á˜áŸ’á–
        </button>
        <button id="modal-close-btn-2" class="bg-gray-400 hover:bg-gray-500 text-white py-2 px-6 rounded-xl font-semibold shadow-md">
          á”á·á‘
        </button>
      </div>
    </div>
  </div>














<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyD61vUNw4gFmzR4zfS8s7FVIzsJe9nXQHQ",
    authDomain: "home-invoice-e1f43.firebaseapp.com",
    projectId: "home-invoice-e1f43"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const customerIdInput = document.getElementById("customer-id");
  const btnSearch = document.getElementById("btnSearch");
  const btnScan = document.getElementById("btnScan");
  const btnStopScan = document.getElementById("btnStopScan");
  const qrVideo = document.getElementById("qr-video");
  const resultsDiv = document.getElementById("results");

  const monthFilter = document.getElementById("month-filter");
  const cartSummary = document.getElementById("cart-summary");
  const totalWaterUsedSpan = document.getElementById("total-water-used");
  const totalWaterPriceSpan = document.getElementById("total-water-price");
  const totalElectricPriceSpan = document.getElementById("total-electric-price");

  // Modal elements
  const invoiceModal = document.getElementById("invoice-modal");
  const modalContentDiv = document.getElementById("modal-content");
  const modalCloseBtn = document.getElementById("modal-close-btn");
  const modalCloseBtn2 = document.getElementById("modal-close-btn-2");
  const modalPrintBtn = document.getElementById("modal-print-btn");

  let invoiceChart = null;
  let scanning = false;
  let videoStream = null;
  let currentInvoices = [];

  btnSearch.addEventListener("click", () => {
    const id = customerIdInput.value.trim();
    if (!id) {
      alert("áŸá¼á˜á”á‰áŸ’á…á¼á› Customer ID á˜á»á“á–áŸá›áŸáŸ’áœáŸ‚á„ášá€");
      return;
    }
    loadInvoicesByCustomerID(id);
  });

  btnScan.addEventListener("click", () => {
    if (scanning) return;
    startScan();
  });

  btnStopScan.addEventListener("click", () => {
    stopScan();
  });















const uploadQRInput = document.getElementById("uploadQRInput");

uploadQRInput.addEventListener("change", (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height, {
        inversionAttempts: "attemptBoth",
      });

     if (code) {
  // code.data á‚áºá‡á¶ string URL á§á‘á¶á ášááŸ https://anrachana.github.io/Nib_web/?id=C001
  try {
    const url = new URL(code.data.trim());
    const id = url.searchParams.get("id"); // á‘á¶á‰ 'id' á–á¸ URL query string

    if (id) {
      customerIdInput.value = id;
      loadInvoicesByCustomerID(id);
    } else {
      alert("âŒ á˜á·á“á¢á¶á…ášá€ parameter id á–á¸ QR Code á”á¶á“á‘áŸáŸ” áŸá¼á˜á–áŸ’á™á¶á™á¶á˜á˜áŸ’áŠá„á‘áŸ€ááŸ”");
    }
  } catch (err) {
    // á”áŸ’ášáŸá·á“á”á¾ code.data á˜á·á“á˜áŸ‚á“á‡á¶ URL ááŸ’ášá¹á˜ááŸ’ášá¼áœ
    customerIdInput.value = code.data.trim();
    loadInvoicesByCustomerID(code.data.trim());
  }
}

    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
});



















  function exportCSV() {
    let data = monthFilter.value
      ? currentInvoices.filter(inv => inv.month === monthFilter.value)
      : currentInvoices;

    if (!data || data.length === 0) {
      alert("âŒ á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™áŸá˜áŸ’ášá¶á”áŸ‹á”á‰áŸ’á‡á¼á“á…áŸá‰á‘áŸáŸ”");
      return;
    }

    let csv = "Invoice Number,Month,Water Old,Water New,Water Used,Water Price,Electric Old,Electric New,Electric Used,Electric Price,Total Price\n";

    data.forEach(inv => {
      const total = (Number(inv.priceWater || 0) + Number(inv.priceElectric || 0));
      csv += `${inv.invoiceNumber || '-'},${inv.month || '-'},${inv.waterOld || '-'},${inv.waterNew || '-'},${inv.waterUsed || '-'},${inv.priceWater || 0},${inv.electricOld || '-'},${inv.electricNew || '-'},${inv.electricUsed || '-'},${inv.priceElectric || 0},${total}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    const fileName = `Invoices_${customerIdInput.value || "unknown"}_${monthFilter.value || "all"}.csv`;
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    link.click();
  }

  async function loadInvoicesByCustomerID(customerID) {
    resultsDiv.innerHTML = `<p class="text-center text-gray-500 italic">á€áŸ†á–á»á„á•áŸ’á‘á»á€...</p>`;
    try {
      const querySnapshot = await db.collection("invoices")
        .where("customerID", "==", customerID)
        .orderBy("timestamp", "desc")
        .limit(50)
        .get();

      if (querySnapshot.empty) {
        resultsDiv.innerHTML = `<p class="text-center text-red-600 font-semibold">á˜á·á“á˜á¶á“ Invoice áŸá˜áŸ’ášá¶á”áŸ‹ Customer ID: <strong>${customerID}</strong></p>`;
        monthFilter.innerHTML = '<option value="">á‘á¶áŸ†á„á¢áŸáŸ‹</option>';
        cartSummary.style.display = 'none';
        currentInvoices = [];
        updateChart([]);
        return;
      }

      currentInvoices = [];
      let monthSet = new Set();

      let html = `
        <h2 class="text-xl font-bold mb-4 text-center">Invoice ášá”áŸáŸ‹ Customer ID: ${customerID}</h2>
        <div class="overflow-auto max-h-96">
        <table id="invoice-table" class="w-full border border-gray-300 text-sm rounded cursor-pointer">
          <thead class="bg-blue-200 sticky top-0">
            <tr>
              <th class="border border-gray-300 px-2 py-1">Invoice Number</th>
              <th class="border border-gray-300 px-2 py-1">ááŸ‚-á†áŸ’á“á¶áŸ†</th>
              <th class="border border-gray-300 px-2 py-1">á‘á¹á€á…á¶áŸáŸ‹</th>
              <th class="border border-gray-300 px-2 py-1">á‘á¹á€ááŸ’á˜á¸</th>
              <th class="border border-gray-300 px-2 py-1">á‘á¹á€á”áŸ’ášá¾</th>
              <th class="border border-gray-300 px-2 py-1">áá˜áŸ’á›áŸƒá‘á¹á€ (áŸ›)</th>
              <th class="border border-gray-300 px-2 py-1">á—áŸ’á›á¾á„á…á¶áŸáŸ‹</th>
              <th class="border border-gray-300 px-2 py-1">á—áŸ’á›á¾á„ááŸ’á˜á¸</th>
              <th class="border border-gray-300 px-2 py-1">á—áŸ’á›á¾á„á”áŸ’ášá¾</th>
              <th class="border border-gray-300 px-2 py-1">áá˜áŸ’á›áŸƒá—áŸ’á›á¾á„ (áŸ›)</th>
              <th class="border border-gray-300 px-2 py-1">áŸášá»á” (áŸ›)</th>
            </tr>
          </thead>
          <tbody>
      `;

      querySnapshot.forEach(doc => {
        const d = doc.data();
        currentInvoices.push(d);
        if(d.month) monthSet.add(d.month);

        html += `
          <tr class="text-center border border-gray-300 hover:bg-blue-100" data-invoice='${encodeURIComponent(JSON.stringify(d))}'>
            <td class="border border-gray-300 px-1 py-0.5">${d.invoiceNumber || '-'}</td>
            <td class="border border-gray-300 px-1 py-0.5">${d.month || '-'}</td>
            <td class="border border-gray-300 px-1 py-0.5">${d.waterOld || '-'}</td>
            <td class="border border-gray-300 px-1 py-0.5">${d.waterNew || '-'}</td>
            <td class="border border-gray-300 px-1 py-0.5">${d.waterUsed || '-'}</td>
            <td class="border border-gray-300 px-1 py-0.5">${(d.priceWater || 0).toLocaleString()}</td>
            <td class="border border-gray-300 px-1 py-0.5">${d.electricOld || '-'}</td>
            <td class="border border-gray-300 px-1 py-0.5">${d.electricNew || '-'}</td>
            <td class="border border-gray-300 px-1 py-0.5">${d.electricUsed || '-'}</td>
            <td class="border border-gray-300 px-1 py-0.5">${(d.priceElectric || 0).toLocaleString()}</td>
            <td class="border border-gray-300 px-1 py-0.5 font-bold">${((d.priceWater || 0) + (d.priceElectric || 0)).toLocaleString()}</td>
          </tr>
        `;
      });

      html += "</tbody></table></div>";

      resultsDiv.innerHTML = html;

      // Build filter dropdown
      let optionsHTML = `<option value="">á‘á¶áŸ†á„á¢áŸáŸ‹</option>`;
      Array.from(monthSet).sort().forEach(month => {
        optionsHTML += `<option value="${month}">${month}</option>`;
      });
      monthFilter.innerHTML = optionsHTML;
      cartSummary.style.display = 'block';

      updateCartSummary();
      updateChart(currentInvoices);

      attachModalOpenOnRowClick();

    } catch (error) {
      console.error("Error loading invoices:", error);
      resultsDiv.innerHTML = `<p class="text-center text-red-600 font-semibold">âŒ á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá‘á¶á‰á‘á·á“áŸ’á“á“áŸá™: ${error.message}</p>`;
      monthFilter.innerHTML = '<option value="">á‘á¶áŸ†á„á¢áŸáŸ‹</option>';
      cartSummary.style.display = 'none';
      currentInvoices = [];
      updateChart([]);
    }
  }

  monthFilter.addEventListener("change", () => {
    filterInvoicesByMonth(monthFilter.value);
  });

  function filterInvoicesByMonth(month) {
    const tbody = document.querySelector("#invoice-table tbody");
    if (!tbody) return;

    tbody.innerHTML = '';

    let filtered = currentInvoices.filter(inv => {
      return month === '' || inv.month === month;
    });

    filtered.forEach(d => {
      const tr = document.createElement("tr");
      tr.className = "text-center border border-gray-300 hover:bg-blue-100";
      tr.dataset.invoice = encodeURIComponent(JSON.stringify(d));
      tr.innerHTML = `
        <td class="border border-gray-300 px-1 py-0.5">${d.invoiceNumber || '-'}</td>
        <td class="border border-gray-300 px-1 py-0.5">${d.month || '-'}</td>
        <td class="border border-gray-300 px-1 py-0.5">${d.waterOld || '-'}</td>
        <td class="border border-gray-300 px-1 py-0.5">${d.waterNew || '-'}</td>
        <td class="border border-gray-300 px-1 py-0.5">${d.waterUsed || '-'}</td>
        <td class="border border-gray-300 px-1 py-0.5">${(d.priceWater || 0).toLocaleString()}</td>
        <td class="border border-gray-300 px-1 py-0.5">${d.electricOld || '-'}</td>
        <td class="border border-gray-300 px-1 py-0.5">${d.electricNew || '-'}</td>
        <td class="border border-gray-300 px-1 py-0.5">${d.electricUsed || '-'}</td>
        <td class="border border-gray-300 px-1 py-0.5">${(d.priceElectric || 0).toLocaleString()}</td>
        <td class="border border-gray-300 px-1 py-0.5 font-bold">${((d.priceWater || 0) + (d.priceElectric || 0)).toLocaleString()}</td>
      `;
      tr.addEventListener("click", () => {
        openInvoiceModal(d);
      });
      tbody.appendChild(tr);
    });

    updateCartSummary(filtered);
    updateChart(filtered);
  }

  function updateCartSummary(invoices = null) {
    const data = invoices || currentInvoices;
    if (!data || data.length === 0) {
      cartSummary.style.display = 'none';
      return;
    }
    cartSummary.style.display = 'block';

    let totalWaterUsed = 0;
    let totalWaterPrice = 0;
    let totalElectricPrice = 0;

    data.forEach(inv => {
      totalWaterUsed += Number(inv.waterUsed || 0);
      totalWaterPrice += Number(inv.priceWater || 0);
      totalElectricPrice += Number(inv.priceElectric || 0);
    });

    totalWaterUsedSpan.textContent = totalWaterUsed.toLocaleString();
    totalWaterPriceSpan.textContent = totalWaterPrice.toLocaleString();
    totalElectricPriceSpan.textContent = totalElectricPrice.toLocaleString();
  }

  function updateChart(invoices) {
    const labels = invoices.map(i => i.month || '');
    const waterPrices = invoices.map(i => Number(i.priceWater || 0));
    const electricPrices = invoices.map(i => Number(i.priceElectric || 0));
    const totalPrices = invoices.map(i => waterPrices[invoices.indexOf(i)] + electricPrices[invoices.indexOf(i)]);

    if (invoiceChart) invoiceChart.destroy();

    const ctx = document.getElementById("invoiceChart").getContext("2d");
    invoiceChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "áá˜áŸ’á›áŸƒá‘á¹á€ (áŸ›)",
            data: waterPrices,
            backgroundColor: "rgba(59, 130, 246, 0.7)",
            borderColor: "rgba(59, 130, 246, 1)",
            borderWidth: 1,
          },
          {
            label: "áá˜áŸ’á›áŸƒá—áŸ’á›á¾á„ (áŸ›)",
            data: electricPrices,
            backgroundColor: "rgba(34, 197, 94, 0.7)",
            borderColor: "rgba(34, 197, 94, 1)",
            borderWidth: 1,
          },
          {
            label: "áŸášá»á” (áŸ›)",
            data: totalPrices,
            backgroundColor: "rgba(249, 115, 22, 0.7)",
            borderColor: "rgba(249, 115, 22, 1)",
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true },
        },
        interaction: {
          mode: 'nearest',
          intersect: false
        }
      },
    });
  }

  // QR code scan logic
  function startScan() {
    scanning = true;
    btnScan.classList.add("hidden");
    btnStopScan.classList.remove("hidden");
    qrVideo.style.display = "block";
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        videoStream = stream;
        qrVideo.srcObject = stream;
        qrVideo.setAttribute("playsinline", true);
        qrVideo.play();
        requestAnimationFrame(tick);
      }).catch(err => {
        alert("á˜á·á“á¢á¶á…á”áŸ’ášá¾á€á¶á˜áŸášáŸ‰á¶ á”á¶á“á‘áŸ: " + err.message);
        stopScan();
      });
  }

  function stopScan() {
    scanning = false;
    btnScan.classList.remove("hidden");
    btnStopScan.classList.add("hidden");
    qrVideo.style.display = "none";
    if (videoStream) {
      videoStream.getTracks().forEach(track => track.stop());
      videoStream = null;
    }
  }

  function tick() {
    if (!scanning) return;
    if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
      const canvas = document.createElement("canvas");
      canvas.width = qrVideo.videoWidth;
      canvas.height = qrVideo.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height, {
        inversionAttempts: "attemptBoth",
      });
      if (code) {
        // Found QR code content
        customerIdInput.value = code.data.trim();
        stopScan();
        loadInvoicesByCustomerID(code.data.trim());
        return;
      }
    }
    requestAnimationFrame(tick);
  }

  // Modal logic
  function openInvoiceModal(invoice) {
    modalContentDiv.innerHTML = `
      <p><strong>Invoice Number:</strong> ${invoice.invoiceNumber || '-'}</p>
      <p><strong>ááŸ‚-á†áŸ’á“á¶áŸ†:</strong> ${invoice.month || '-'}</p>
      <table class="w-full border border-gray-300 mt-4 text-sm">
        <thead>
          <tr class="bg-blue-200 text-center">
            <th class="border border-gray-300 px-2 py-1">á‘á¹á€á…á¶áŸáŸ‹</th>
            <th class="border border-gray-300 px-2 py-1">á‘á¹á€ááŸ’á˜á¸</th>
            <th class="border border-gray-300 px-2 py-1">á‘á¹á€á”áŸ’ášá¾</th>
            <th class="border border-gray-300 px-2 py-1">áá˜áŸ’á›áŸƒá‘á¹á€ (áŸ›)</th>
            <th class="border border-gray-300 px-2 py-1">á—áŸ’á›á¾á„á…á¶áŸáŸ‹</th>
            <th class="border border-gray-300 px-2 py-1">á—áŸ’á›á¾á„ááŸ’á˜á¸</th>
            <th class="border border-gray-300 px-2 py-1">á—áŸ’á›á¾á„á”áŸ’ášá¾</th>
            <th class="border border-gray-300 px-2 py-1">áá˜áŸ’á›áŸƒá—áŸ’á›á¾á„ (áŸ›)</th>
            <th class="border border-gray-300 px-2 py-1">áŸášá»á” (áŸ›)</th>
          </tr>
        </thead>
        <tbody>
          <tr class="text-center">
            <td class="border border-gray-300 px-2 py-1">${invoice.waterOld || '-'}</td>
            <td class="border border-gray-300 px-2 py-1">${invoice.waterNew || '-'}</td>
            <td class="border border-gray-300 px-2 py-1">${invoice.waterUsed || '-'}</td>
            <td class="border border-gray-300 px-2 py-1">${(Number(invoice.priceWater) || 0).toLocaleString()}</td>
            <td class="border border-gray-300 px-2 py-1">${invoice.electricOld || '-'}</td>
            <td class="border border-gray-300 px-2 py-1">${invoice.electricNew || '-'}</td>
            <td class="border border-gray-300 px-2 py-1">${invoice.electricUsed || '-'}</td>
            <td class="border border-gray-300 px-2 py-1">${(Number(invoice.priceElectric) || 0).toLocaleString()}</td>
            <td class="border border-gray-300 px-2 py-1 font-bold">${((Number(invoice.priceWater) || 0) + (Number(invoice.priceElectric) || 0)).toLocaleString()}</td>
          </tr>
        </tbody>
      </table>
    `;

    invoiceModal.style.display = "flex";
    invoiceModal.dataset.currentInvoice = encodeURIComponent(JSON.stringify(invoice));
  }

  function closeInvoiceModal() {
    invoiceModal.style.display = "none";
    invoiceModal.dataset.currentInvoice = null;
  }

  modalCloseBtn.addEventListener("click", closeInvoiceModal);
  modalCloseBtn2.addEventListener("click", closeInvoiceModal);

  modalPrintBtn.addEventListener("click", () => {
    if (!invoiceModal.dataset.currentInvoice) return;
    const invoice = JSON.parse(decodeURIComponent(invoiceModal.dataset.currentInvoice));
    printInvoice(invoice);
  });

  function printInvoice(invoice) {
    // Create printable window content
    const printWindow = window.open('', '', 'width=700,height=600');
    const totalPrice = (Number(invoice.priceWater || 0) + Number(invoice.priceElectric || 0)).toLocaleString();
    printWindow.document.write(`
      <html>
        <head>
          <title>Print Invoice</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h2 { text-align: center; color: #2563eb; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
            th { background-color: #bfdbfe; }
            tfoot td { font-weight: bold; }
          </style>
        </head>
        <body>
          <h2>áœá·á€áŸ’á€á™á”ááŸ’áš Invoice</h2>
          <p><strong>Invoice Number:</strong> ${invoice.invoiceNumber || '-'}</p>
          <p><strong>ááŸ‚-á†áŸ’á“á¶áŸ†:</strong> ${invoice.month || '-'}</p>
          <table>
            <thead>
              <tr>
                <th>á‘á¹á€á…á¶áŸáŸ‹</th><th>á‘á¹á€ááŸ’á˜á¸</th><th>á‘á¹á€á”áŸ’ášá¾</th><th>áá˜áŸ’á›áŸƒá‘á¹á€ (áŸ›)</th>
                <th>á—áŸ’á›á¾á„á…á¶áŸáŸ‹</th><th>á—áŸ’á›á¾á„ááŸ’á˜á¸</th><th>á—áŸ’á›á¾á„á”áŸ’ášá¾</th><th>áá˜áŸ’á›áŸƒá—áŸ’á›á¾á„ (áŸ›)</th>
                <th>áŸášá»á” (áŸ›)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>${invoice.waterOld || '-'}</td>
                <td>${invoice.waterNew || '-'}</td>
                <td>${invoice.waterUsed || '-'}</td>
                <td>${(Number(invoice.priceWater) || 0).toLocaleString()}</td>
                <td>${invoice.electricOld || '-'}</td>
                <td>${invoice.electricNew || '-'}</td>
                <td>${invoice.electricUsed || '-'}</td>
                <td>${(Number(invoice.priceElectric) || 0).toLocaleString()}</td>
                <td>${totalPrice}</td>
              </tr>
            </tbody>
          </table>
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
  }

  // Attach click event on table rows for modal open
  function attachModalOpenOnRowClick() {
    const rows = document.querySelectorAll("#invoice-table tbody tr");
    rows.forEach(row => {
      row.onclick = () => {
        const invoiceEncoded = row.dataset.invoice;
        const invoice = JSON.parse(decodeURIComponent(invoiceEncoded));
        openInvoiceModal(invoice);
      };
    });
  }
</script>
<script>
  const toggleBtn = document.getElementById("chat-toggle");
  const chatBox = document.getElementById("chat-box");
  const chatInput = document.getElementById("chat-input");
  const sendButton = document.getElementById("send-button");
  const chatMessages = document.getElementById("chat-messages");

  let isOpen = false;

  toggleBtn.addEventListener("click", () => {
    isOpen = !isOpen;
    if (isOpen) {
      chatBox.classList.remove("hidden");
      // Add animation classes
      requestAnimationFrame(() => {
        chatBox.classList.remove("opacity-0", "scale-95");
        chatBox.classList.add("opacity-100", "scale-100");
      });
      chatInput.focus();
    } else {
      // Add closing animation
      chatBox.classList.remove("opacity-100", "scale-100");
      chatBox.classList.add("opacity-0", "scale-95");

      // Hide after animation ends
      setTimeout(() => {
        if (!isOpen) chatBox.classList.add("hidden");
      }, 300); // Match duration-300
    }
  });

  function addMessage(message, sender = "user") {
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("p-2", "rounded-md", "text-sm", "max-w-[75%]");
    if (sender === "user") {
      msgDiv.classList.add("bg-blue-100", "self-end", "text-right", "ml-auto");
    } else {
      msgDiv.classList.add("bg-gray-100", "text-left");
    }
    msgDiv.textContent = message;
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  sendButton.addEventListener("click", () => {
    const message = chatInput.value.trim();
    if (message) {
      addMessage(message, "user");
      chatInput.value = "";
      setTimeout(() => {
        addMessage("áŸá¼á˜á¢ášá‚á»á! á™á¾á„á“á¹á„á†áŸ’á›á¾á™áá”á†á¶á”áŸ‹áŸ—á“áŸáŸ‡áŸ”", "bot");
      }, 600);
    }
  });

  chatInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendButton.click();
  });
</script>




</body>
</html>
