<!DOCTYPE html>
<html lang="km" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>á–áŸááŸŒá˜á¶á“á¢áá·áá·á‡á“ + QR Scan + áŸáŸ†á¡áŸá„</title>
  
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: #f0f0f0;
    }
    ::-webkit-scrollbar-thumb {
      background-color: #2563eb;
      border-radius: 3px;
    }
    #qr-video {
      border-radius: 1rem;
      width: 100%;
      max-height: 280px;
      object-fit: cover;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      margin-top: 1rem;
      display: none;
    }
    #upload-preview {
      max-width: 100%;
      border-radius: 1rem;
      margin-top: 1rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      display: none;
    }
  </style>
</head>
<body class="bg-gradient-to-tr from-blue-50 to-indigo-100 min-h-screen flex flex-col justify-center items-center p-4">

  <div class="bg-white rounded-3xl shadow-xl max-w-md w-full p-6 flex flex-col items-center">

    <h1 class="text-3xl font-extrabold text-blue-700 mb-6 text-center">á–áŸááŸŒá˜á¶á“á¢áá·áá·á‡á“</h1>

    <div class="w-full flex flex-col space-y-3">
      <input id="customer-id" type="text" placeholder="áŸá¼á˜á”á‰áŸ’á…á¼á›á›áŸá ID á¬ Scan QR" autocomplete="off"
        class="rounded-xl border border-gray-300 px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />

      <div class="flex gap-4 flex-wrap justify-center">
        <button id="btnSearch" class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-8 rounded-xl font-semibold shadow-md transition">
          ğŸ” áŸáŸ’áœáŸ‚á„ášá€
        </button>

        <button id="btnScan" class="bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-8 rounded-xl font-semibold shadow-md transition">
          ğŸ“· Scan QR
        </button>

        <label for="qr-upload" class="bg-green-600 hover:bg-green-700 cursor-pointer text-white py-3 px-6 rounded-xl font-semibold shadow-md transition flex items-center gap-2 select-none">
          ğŸ“ Upload QR
        </label>
        <input id="qr-upload" type="file" accept="image/*" class="hidden" />
      </div>
    </div>

    <video id="qr-video" autoplay muted playsinline></video>
    <img id="upload-preview" alt="Preview QR upload image" />

    <div id="customerContent" class="w-full mt-6 text-gray-700 min-h-[160px] text-lg leading-relaxed select-text p-4 rounded-xl bg-indigo-50 shadow-inner">
      <p class="text-center text-gray-400 italic">áŸá¼á˜áŸáŸ’áœáŸ‚á„ášá€á–áŸááŸŒá˜á¶á“á¢áá·áá·á‡á“</p>
    </div>

    <div id="actionButtons" class="mt-8 w-full flex justify-center gap-6 hidden">
      <button id="printBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl shadow-md font-semibold transition" aria-label="á”áŸ„áŸ‡á–á»á˜áŸ’á–">
        ğŸ–¨ï¸ á”áŸ„áŸ‡á–á»á˜áŸ’á–
      </button>
      <button id="pdfBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl shadow-md font-semibold transition" aria-label="á‘á¶á‰á™á€ PDF">
        â¬‡ï¸ á‘á¶á‰á™á€ PDF
      </button>
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
    <div class="flex flex-col items-center space-y-4 text-white font-semibold text-lg">
      <svg class="animate-spin h-12 w-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
      </svg>
      <div>á€áŸ†á–á»á„á•áŸ’á‘á»á€...</div>
    </div>
  </div>

<script>
  // Firebase config (replace with your config)
  const firebaseConfig = {
    apiKey: "AIzaSyD61vUNw4gFmzR4zfS8s7FVIzsJe9nXQHQ",
    authDomain: "home-invoice-e1f43.firebaseapp.com",
    projectId: "home-invoice-e1f43"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const loadingOverlay = document.getElementById("loadingOverlay");
  const customerContent = document.getElementById("customerContent");
  const actionButtons = document.getElementById("actionButtons");
  const printBtn = document.getElementById("printBtn");
  const pdfBtn = document.getElementById("pdfBtn");
  const customerIdInput = document.getElementById("customer-id");
  const qrVideo = document.getElementById("qr-video");
  const uploadPreview = document.getElementById("upload-preview");

  let currentCustomer = null;
  let scanning = false;
  let videoStream = null;

  // Audio elements for success and error
  const audioSuccess = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
  const audioError = new Audio("https://actions.google.com/sounds/v1/cartoon/slide_whistle_to_drum_hit.ogg");

  function playSuccessSound() {
    audioSuccess.play().catch(() => {});
  }
  function playErrorSound() {
    audioError.play().catch(() => {});
  }

  function showLoading(show = true) {
    loadingOverlay.style.display = show ? "flex" : "none";
  }

  function getIDfromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get("id");
  }

  function renderCustomer(data) {
    customerContent.innerHTML = `
      <p><span class="font-bold">á¢ááŸ’ááŸá‰áŸ’á‰á¶á:</span> ${data.id || "-"}</p>
      <p><span class="font-bold">áˆáŸ’á˜áŸ„áŸ‡:</span> ${data.name || "-"}</p>
      <p><span class="font-bold">á›áŸáá”á“áŸ’á‘á”áŸ‹:</span> ${data.room || "-"}</p>
      <p><span class="font-bold">á‘á¼ášáŸáŸá–áŸ’á‘:</span> ${data.phone || "-"}</p>
      ${data.phone2 ? `<p><span class="font-bold">á‘á¼ášáŸáŸá–áŸ’á‘ 2:</span> ${data.phone2}</p>` : ""}
    `;
    actionButtons.classList.remove("hidden");
    currentCustomer = data;
    playSuccessSound();
  }

  async function loadCustomer(id) {
    if (!id) {
      customerContent.innerHTML = `<p class="text-red-600 font-semibold text-center">âŒ á˜á·á“á˜á¶á“ ID á“áŸ…á€áŸ’á“á»á„ URL</p>`;
      actionButtons.classList.add("hidden");
      playErrorSound();
      return;
    }
    showLoading(true);
    try {
      const doc = await db.collection("customers").doc(id).get();
      if (doc.exists) {
        renderCustomer({ id, ...doc.data() });
      } else {
        customerContent.innerHTML = `<p class="text-red-600 font-semibold text-center">âŒ á˜á·á“á˜á¶á“á¢áá·áá·á‡á“á“áŸáŸ‡á‘áŸ</p>`;
        actionButtons.classList.add("hidden");
        playErrorSound();
      }
    } catch (e) {
      console.error(e);
      customerContent.innerHTML = `<p class="text-red-600 font-semibold text-center">âŒ á€á¾áá˜á¶á“á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá‘á¶á‰á‘á·á“áŸ’á“á“áŸá™</p>`;
      actionButtons.classList.add("hidden");
      playErrorSound();
    } finally {
      showLoading(false);
    }
  }

  function printCustomerInfo() {
    if (!currentCustomer) {
      alert("áŸá¼á˜á‘á¶á‰á™á€á–áŸááŸŒá˜á¶á“á¢áá·áá·á‡á“á˜á»á“á–áŸá›á”áŸ„áŸ‡á–á»á˜áŸ’á–");
      return;
    }
    const win = window.open("", "", "width=600,height=400");
    win.document.write("<html><head><title>á”áŸ„áŸ‡á–á»á˜áŸ’á–á–áŸááŸŒá˜á¶á“á¢áá·áá·á‡á“</title></head><body>");
    win.document.write(`<pre style="font-family: Kanit, sans-serif; font-size: 18px; padding: 20px;">
á¢ááŸ’ááŸá‰áŸ’á‰á¶á: ${currentCustomer.id}
áˆáŸ’á˜áŸ„áŸ‡: ${currentCustomer.name || '-'}
á›áŸáá”á“áŸ’á‘á”áŸ‹: ${currentCustomer.room || '-'}
á‘á¼ášáŸáŸá–áŸ’á‘: ${currentCustomer.phone || '-'}
${currentCustomer.phone2 ? 'á‘á¼ášáŸáŸá–áŸ’á‘ 2: ' + currentCustomer.phone2 : ''}
</pre>`);
    win.document.write("</body></html>");
    win.document.close();
    win.focus();
    win.print();
    win.close();
  }

  async function downloadPDF() {
    if (!currentCustomer) {
      alert("áŸá¼á˜á‘á¶á‰á™á€á–áŸááŸŒá˜á¶á“á¢áá·áá·á‡á“á˜á»á“á–áŸá›á‘á¶á‰á™á€ PDF");
      return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text("á–áŸááŸŒá˜á¶á“á¢áá·áá·á‡á“", 20, 20);

    doc.setFontSize(14);
    doc.text(`á¢ááŸ’ááŸá‰áŸ’á‰á¶á: ${currentCustomer.id}`, 20, 40);
    doc.text(`áˆáŸ’á˜áŸ„áŸ‡: ${currentCustomer.name || '-'}`, 20, 50);
    doc.text(`á›áŸáá”á“áŸ’á‘á”áŸ‹: ${currentCustomer.room || '-'}`, 20, 60);
    doc.text(`á‘á¼ášáŸáŸá–áŸ’á‘: ${currentCustomer.phone || '-'}`, 20, 70);
    if(currentCustomer.phone2) {
      doc.text(`á‘á¼ášáŸáŸá–áŸ’á‘ 2: ${currentCustomer.phone2}`, 20, 80);
    }

    doc.save(`Customer_${currentCustomer.id}.pdf`);
  }

  // Event bindings
  printBtn.addEventListener("click", printCustomerInfo);
  pdfBtn.addEventListener("click", downloadPDF);

  document.getElementById("btnSearch").addEventListener("click", () => {
    const id = customerIdInput.value.trim();
    if (!id) {
      alert("áŸá¼á˜á”á‰áŸ’á…á¼á›á›áŸá ID á˜á»á“á–áŸá›áŸáŸ’áœáŸ‚á„ášá€");
      return;
    }
    // Set URL param + reload page or just load customer
    history.replaceState(null, '', `?id=${encodeURIComponent(id)}`);
    loadCustomer(id);
  });

  // QR Upload
  document.getElementById("qr-upload").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        uploadPreview.src = img.src;
        uploadPreview.style.display = "block";

        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if (code && code.data) {
          // Extract ID param if URL or direct ID
          let scannedData = code.data.trim();
          // If URL format: https://anrachana.github.io/Nib_web/?id=XXXXX
          try {
            const url = new URL(scannedData);
            if (url.searchParams.has("id")) {
              scannedData = url.searchParams.get("id");
            }
          } catch {}

          customerIdInput.value = scannedData;
          // Update URL param
          history.replaceState(null, '', `?id=${encodeURIComponent(scannedData)}`);
          loadCustomer(scannedData);
        } else {
          alert("á˜á·á“á¢á¶á…á¢á¶á“ QR á”á¶á“á‘áŸ");
          playErrorSound();
        }
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });

  // QR Live Scan
  document.getElementById("btnScan").addEventListener("click", async () => {
    if (scanning) return; // already scanning

    try {
      videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      qrVideo.srcObject = videoStream;
      qrVideo.style.display = "block";
      scanning = true;

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      const scanLoop = () => {
        if (!scanning) return;
        if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
          canvas.width = qrVideo.videoWidth;
          canvas.height = qrVideo.videoHeight;
          ctx.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);

          if (code && code.data) {
            scanning = false;
            qrVideo.style.display = "none";
            if (videoStream) {
              videoStream.getTracks().forEach(track => track.stop());
              videoStream = null;
            }

            // Extract ID param if URL or direct ID
            let scannedData = code.data.trim();
            try {
              const url = new URL(scannedData);
              if (url.searchParams.has("id")) {
                scannedData = url.searchParams.get("id");
              }
            } catch {}

            customerIdInput.value = scannedData;
            history.replaceState(null, '', `?id=${encodeURIComponent(scannedData)}`);
            loadCustomer(scannedData);
            return;
          }
        }
        requestAnimationFrame(scanLoop);
      };

      requestAnimationFrame(scanLoop);
    } catch (err) {
      alert("á˜á·á“á¢á¶á…á…á¼á›á”áŸ’ášá¾á€á¶á˜áŸášáŸ‰á¶");
      console.error(err);
      playErrorSound();
    }
  });

  // On page load auto get ID from URL and load customer
  window.addEventListener("DOMContentLoaded", () => {
    const id = getIDfromURL();
    if (id) {
      customerIdInput.value = id;
      loadCustomer(id);
    } else {
      customerContent.innerHTML = `<p class="text-gray-400 text-center italic">áŸá¼á˜áŸáŸ’áœáŸ‚á„ášá€á–áŸááŸŒá˜á¶á“á¢áá·áá·á‡á“</p>`;
      actionButtons.classList.add("hidden");
    }
  });

</script>

</body>
</html>
